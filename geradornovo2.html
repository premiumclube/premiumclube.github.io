<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador Inteligente - Premium Clube</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body class="text-slate-900 p-6">
    <div id="auth-screen" class="fixed inset-0 bg-[#1e3668] z-[100] flex items-center justify-center p-6">
        <div class="bg-white p-8 rounded-[40px] shadow-2xl max-w-sm w-full text-center">
            <i data-lucide="shield-check" class="w-12 h-12 text-[#1e3668] mx-auto mb-4"></i>
            <h2 class="text-2xl font-black text-[#1e3668] uppercase italic mb-2">Acesso Restrito</h2>
            <p class="text-slate-500 font-bold text-sm mb-6">Digite a senha de consultor para acessar o gerador.</p>
            <input type="password" id="pass"
                class="w-full p-4 bg-slate-100 border rounded-2xl mb-4 text-center font-bold outline-none focus:ring-2 focus:ring-orange-500">
            <button onclick="checkAuth()"
                class="w-full bg-[#1e3668] text-white font-black py-4 rounded-2xl uppercase italic">Entrar no
                Painel</button>
        </div>
    </div>

    <div id="main-content" class="max-w-4xl mx-auto space-y-8 hidden">

        <div class="bg-white rounded-3xl p-8 shadow-2xl border border-slate-200">
            <div class="flex items-center gap-4 mb-8 border-b pb-4">
                <i data-lucide="zap" class="w-8 h-8 text-orange-500"></i>
                <h1 class="text-3xl font-black text-[#1e3668] uppercase italic">Gerador Inteligente v2</h1>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">Nome do
                        Cliente</label>
                    <input type="text" id="nomeCliente" placeholder="Ex: João Silva"
                        class="w-full p-4 bg-slate-50 border rounded-2xl focus:ring-2 focus:ring-[#1e3668] outline-none font-bold">
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">WhatsApp
                        do Cliente</label>
                    <input type="tel" id="telCliente" placeholder="Ex: 77999999999"
                        class="w-full p-4 bg-slate-50 border rounded-2xl focus:ring-2 focus:ring-[#1e3668] outline-none font-bold">
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">Link do
                        PDF da Cotação (Opcional)</label>
                    <input type="url" id="pdfLink" placeholder="Cole o link do PDF aqui..."
                        class="w-full p-4 bg-slate-50 border rounded-2xl focus:ring-2 focus:ring-[#1e3668] outline-none font-bold">
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">Conteúdo da
                    Cotação (Texto ou JSON)</label>
                <textarea id="rawInput" rows="8" placeholder="Cole aqui o texto da cotação recebida no sistema..."
                    class="w-full p-4 bg-slate-50 border rounded-2xl focus:ring-2 focus:ring-[#1e3668] outline-none font-mono text-sm"></textarea>
                <button onclick="interpretarTexto()"
                    class="mt-2 text-xs font-bold text-orange-600 uppercase flex items-center gap-1 hover:underline">
                    <i data-lucide="wand-2" class="w-3 h-3"></i> Tentar interpretar texto colado
                </button>
            </div>

            <div class="mb-8">
                <label class="block text-[10px] font-black uppercase tracking-widest text-slate-400 mb-4">Coberturas
                    Opcionais Selecionadas</label>
                <div id="opcionais-checkboxes" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <label class="flex items-center gap-3 p-3 border rounded-xl cursor-pointer hover:bg-slate-50">
                        <input type="checkbox" value="Vidros, parabrisas, retrovisores, faróis"
                            class="w-5 h-5 accent-[#1e3668]">
                        <span class="text-[11px] font-bold uppercase">Vidros, parabrisas, retrovisores, faróis</span>
                    </label>
                    <label class="flex items-center gap-3 p-3 border rounded-xl cursor-pointer hover:bg-slate-50">
                        <input type="checkbox" value="Kit GNV (até 3500)" class="w-5 h-5 accent-[#1e3668]">
                        <span class="text-[11px] font-bold uppercase">Kit GNV (até 3500)</span>
                    </label>
                    <label class="flex items-center gap-3 p-3 border rounded-xl cursor-pointer hover:bg-slate-50">
                        <input type="checkbox" value="Kit GNV (até 4500)" class="w-5 h-5 accent-[#1e3668]">
                        <span class="text-[11px] font-bold uppercase">Kit GNV (até 4500)</span>
                    </label>
                    <label class="flex items-center gap-3 p-3 border rounded-xl cursor-pointer hover:bg-slate-50">
                        <input type="checkbox" value="Kit GNV (até 6000)" class="w-5 h-5 accent-[#1e3668]">
                        <span class="text-[11px] font-bold uppercase">Kit GNV (até 6000)</span>
                    </label>
                    <label class="flex items-center gap-3 p-3 border rounded-xl cursor-pointer hover:bg-slate-50">
                        <input type="checkbox" value="Fenômenos da Natureza" class="w-5 h-5 accent-[#1e3668]">
                        <span class="text-[11px] font-bold uppercase">Fenômenos da Natureza</span>
                    </label>
                    <label class="flex items-center gap-3 p-3 border rounded-xl cursor-pointer hover:bg-slate-50">
                        <input type="checkbox" value="Proteção Terceiro +R$ 100.000,00"
                            class="w-5 h-5 accent-[#1e3668]">
                        <span class="text-[11px] font-bold uppercase">Proteção Terceiro +R$ 100.000</span>
                    </label>
                    <label class="flex items-center gap-3 p-3 border rounded-xl cursor-pointer hover:bg-slate-50">
                        <input type="checkbox" value="Monitoramento/Rastreamento" class="w-5 h-5 accent-[#1e3668]">
                        <span class="text-[11px] font-bold uppercase">Monitoramento/Rastreamento</span>
                    </label>
                </div>
            </div>

            <div class="bg-orange-50 p-6 rounded-3xl border border-orange-200 mt-6">
                <h3 class="text-orange-800 font-black uppercase italic text-sm mb-4 flex items-center gap-2">
                    <i data-lucide="lock" class="w-4 h-4"></i> Reserva de Proposta (Pendente)
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                    <label class="flex items-center gap-2 text-[10px] font-bold uppercase cursor-pointer">
                        <input type="checkbox" class="doc-check" value="cnh"> CNH Enviada
                    </label>
                    <label class="flex items-center gap-2 text-[10px] font-bold uppercase cursor-pointer">
                        <input type="checkbox" class="doc-check" value="doc"> Doc. Veículo Enviado
                    </label>
                    <label class="flex items-center gap-2 text-[10px] font-bold uppercase cursor-pointer">
                        <input type="checkbox" class="doc-check" value="end"> Comprovante Enviado
                    </label>
                    <label class="flex items-center gap-2 text-[10px] font-bold uppercase cursor-pointer">
                        <input type="checkbox" class="doc-check" value="email"> E-mail Informado
                    </label>
                    <label class="flex items-center gap-2 text-[10px] font-bold uppercase cursor-pointer">
                        <input type="checkbox" class="doc-check" value="tel"> Telefone Informado
                    </label>
                    <label class="flex items-center gap-2 text-[10px] font-bold uppercase cursor-pointer">
                        <input type="checkbox" class="doc-check" value="venc"> Vencimento Definido
                    </label>
                    <label class="flex items-center gap-2 text-[10px] font-bold uppercase cursor-pointer">
                        <input type="checkbox" id="checkRastreador" class="extras-check"
                            value="rastreador_bonus">
                        Bônus Rastreador FIPE 40k+
                    </label>
                </div>

                <div class="flex items-center gap-4">
                    <div class="flex-1">
                        <label class="block text-[9px] font-black uppercase text-orange-400 mb-1">Expira em quantos
                            dias?</label>
                        <input type="number" id="expiraDias" value="2"
                            class="w-full p-2 rounded-lg border-none font-bold outline-none">
                    </div>
                    <button onclick="gerarPreAtivacao()"
                        class="flex-[2] bg-orange-600 text-white font-black py-3 rounded-xl uppercase italic text-xs shadow-lg hover:bg-orange-700 transition-all">
                        Gerar Link de Pré-Ativação
                    </button>
                </div>
            </div>

            <button onclick="gerarProposta()"
                class="w-full bg-[#1e3668] text-white font-black py-6 rounded-[2rem] shadow-xl hover:scale-[1.01] transition-all uppercase italic text-xl flex items-center justify-center gap-3">
                <i data-lucide="share-2"></i> Gerar e Abrir Proposta
            </button>
        </div>

        <div class="bg-white rounded-3xl p-8 shadow-2xl border border-slate-200">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-4">
                    <i data-lucide="history" class="w-6 h-6 text-slate-400"></i>
                    <h2 class="text-xl font-black text-[#1e3668] uppercase italic">Últimas Geradas</h2>
                </div>
                <button onclick="limparHistorico()"
                    class="text-[10px] font-black text-red-400 uppercase hover:text-red-600">Limpar Cache</button>
            </div>
            <div id="historicoLista" class="space-y-3"></div>
        </div>
    </div>

    <script>
        function gerarPreAtivacao() {
            // 1. Captura os elementos básicos
            const nome = document.getElementById('nomeCliente').value;
            const tel = document.getElementById('telCliente').value;
            const pdf = document.getElementById('pdfLink').value;
            const expiraDias = document.getElementById('expiraDias').value || 2;
            const jsonRaw = document.getElementById('rawInput').value;

            // 2. O bloco TRY deve envolver o PARSE do JSON para evitar travamentos
            try {
                if (!jsonRaw || jsonRaw.trim() === "") {
                    throw new Error("Cole o texto e clique em INTERPRETAR primeiro!");
                }

                const d = JSON.parse(jsonRaw);
                const cotacaoId = d.cotacao_numero || "8837175";

                // 3. Lógica do Cronômetro (Persistência)
                const chaveTempo = 'oferta_expira_em_' + cotacaoId;
                if (!localStorage.getItem(chaveTempo)) {
                    const tempoFinal = Math.floor(Date.now() / 1000) + (expiraDias * 86400);
                    localStorage.setItem(chaveTempo, tempoFinal);
                }

                // 4. Montagem do Payload
                const payload = {
                    cliente: { nome, tel, pdf },
                    dados: d,
                    // Captura os documentos marcados (CNH, Doc, etc)
                    checks: Array.from(document.querySelectorAll('.doc-check:checked')).map(c => c.value),
                    // Captura TODOS os checkboxes que tenham a classe .extras-check (incluindo o Rastreador)
                    extras: Array.from(document.querySelectorAll('.extras-check:checked')).map(c => c.value),
                    expiraDias: expiraDias
                };

                // 5. Gera a URL
                const base64 = btoa(encodeURIComponent(JSON.stringify(payload)));
                // Ajustado para aceitar tanto geradornovo.html quanto geradornovo2.html
                const urlBase = window.location.href.split('gerador')[0];
                const finalUrl = `${urlBase}preativacao.html?data=${base64}`;

                // 6. Copia e abre
                navigator.clipboard.writeText(finalUrl);
                alert('Link de PRÉ-ATIVAÇÃO copiado com sucesso!');
                window.open(finalUrl, '_blank');

            } catch (e) {
                alert('Erro: ' + e.message);
                console.error("Erro na geração:", e);
            }
        }
        lucide.createIcons();
        function checkAuth() {
            const hash = "ODk2OA==";
            if (btoa(document.getElementById('pass').value) === hash) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                listarHistorico();
            } else {
                alert('Senha incorreta!');
            }
        }

        function interpretarTexto() {
            const txt = document.getElementById('rawInput').value;
            if (!txt || txt.trim().startsWith('{')) return;

            try {
                const extrair = (regex, index = 1) => {
                    const match = txt.match(regex);
                    return match && match[index] ? match[index].trim() : "";
                };

                // Captura da Categoria (Lógica para pegar o que estiver entre "Categoria:" e "Cidade:")
                const categoriaMatch = txt.match(/Categoria:\s*([\s\S]*?)\s*Cidade:/i);
                const categoria = categoriaMatch ? categoriaMatch[1].replace(/\n/g, ' ').trim() : "";

                // Captura das Proteções Dinâmicas
                const protecoes = [];
                if (txt.includes("Casco")) protecoes.push({ item: extrair(/(Casco\s*\d+%\s*FIPE)/i, 0) || "Casco 100% FIPE" });

                const r3Match = txt.match(/Cobertura terceiros\s*\n?R\$\s*([\d.,]+)/i);
                if (r3Match) protecoes.push({ item: `Terceiros R$ ${r3Match[1]}` });

                if (txt.toLowerCase().includes("carro reserva")) {
                    const dias = txt.match(/até\s*(\d+)\s*dias/i);
                    protecoes.push({ item: dias ? `Carro Reserva ${dias[1]} dias` : "Carro Reserva" });
                }

                // Adicionais fixos que sempre constam no texto
                if (txt.includes("Roubo") || txt.includes("FIPE")) protecoes.push({ item: "Roubo, Furto e Incêndio" });

                const mockJson = {
                    consultor: extrair(/Consultor:\s*(.*)/i),
                    data_hora: extrair(/Data\/hora:\s*(.*)/i),
                    cotacao_numero: extrair(/Cotação:\s*(\d+)/i),
                    veiculo: {
                        modelo: extrair(/Modelo:\s*(.*)/i),
                        placa: extrair(/Placa:\s*(.*)/i) || "SEM PLACA",
                        ano: extrair(/Ano:\s*(.*)/i),
                        valor_fipe: extrair(/Valor FIPE\s*\n?R\$\s*([\d.,]+)/i) || extrair(/R\$\s*([\d.,]+)/i),
                        cidade: extrair(/Cidade:\s*(.*)/i),
                        uf: extrair(/UF:\s*(.*)/i),
                        categoria: categoria
                    },
                    financeiro: {
                        mensalidade: {
                            valor_original: "R$ " + extrair(/De:\s*\n?R\$\s*([\d.,]+)/i),
                            valor_atual: "R$ " + extrair(/Por:\s*\n?R\$\s*([\d.,]+)/i),
                            detalhe_desconto: extrair(/Desconto\s*([\s\S]*?)\s*Contratação/i).split('\n')[0].trim() || "Promocional"
                        },
                        contratacao: {
                            taxa_unica: "R$ " + (extrair(/Taxa única\s*\n?R\$\s*([\d.,]+)/i) || "350,00"),
                            cota_participacao: extrair(/Cota de Participação\s*\n?(\d+\s*x\s*R\$\s*[\d.,]+)/i) || extrair(/Cota de participação\s*\n?([\d.,]+)/i)
                        }
                    },
                    protecoes_inclusas: protecoes
                };

                // Limpeza de campos vazios ou duplicados no desconto
                if (mockJson.financeiro.mensalidade.detalhe_desconto.length > 50) {
                    mockJson.financeiro.mensalidade.detalhe_desconto = "Desconto Especial Aplicado";
                }

                document.getElementById('rawInput').value = JSON.stringify(mockJson, null, 2);

                // Alerta visual de sucesso
                const btn = document.querySelector('button[onclick="interpretarTexto()"]');
                btn.innerHTML = "Texto Interpretado!";
                btn.classList.replace('bg-orange-500', 'bg-green-600');
                setTimeout(() => {
                    btn.innerHTML = "Interpretar Texto";
                    btn.classList.replace('bg-green-600', 'bg-orange-500');
                }, 2000);

            } catch (e) {
                alert("Erro ao ler o texto. Verifique o formato.");
                console.error(e);
            }
        }

        function gerarProposta() {
            const pdfUrl = document.getElementById('pdfLink').value;
            const nome = document.getElementById('nomeCliente').value;
            const tel = document.getElementById('telCliente').value;
            let jsonRaw = document.getElementById('rawInput').value;

            if (!nome || !jsonRaw) { alert('Preencha Nome e Dados da Cotação!'); return; }

            try {
                const dataObj = JSON.parse(jsonRaw);
                const payload = {
                    cliente: {
                        nome: nome,
                        tel: tel,
                        pdf: pdfUrl // Adicionado ao payload
                    },
                    dados: dataObj,
                    extras: Array.from(document.querySelectorAll('#opcionais-checkboxes input:checked')).map(c => c.value)
                };

                const base64 = btoa(encodeURIComponent(JSON.stringify(payload)));
                const urlBase = window.location.href.split('geradornovo.html')[0];
                const finalUrl = `${urlBase}proposta.html?data=${base64}`;

                salvarNoCache(nome, dataObj.veiculo.modelo, finalUrl);
                navigator.clipboard.writeText(finalUrl);
                window.open(finalUrl, '_blank');
                listarHistorico();
            } catch (e) { alert('Erro no JSON. Verifique se o texto foi interpretado corretamente.'); }
        }

        function salvarNoCache(nome, modelo, url) {
            let historico = JSON.parse(localStorage.getItem('historico_propostas') || '[]');
            historico.unshift({ id: Date.now(), nome, modelo, url, data: new Date().toLocaleString('pt-BR') });
            localStorage.setItem('historico_propostas', JSON.stringify(historico.slice(0, 15)));
        }

        function listarHistorico() {
            const lista = document.getElementById('historicoLista');
            const historico = JSON.parse(localStorage.getItem('historico_propostas') || '[]');
            if (historico.length === 0) { lista.innerHTML = '<p class="text-slate-400 text-sm italic">Vazio</p>'; return; }

            lista.innerHTML = historico.map(item => `
                <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100">
                    <div class="overflow-hidden">
                        <p class="text-[10px] font-black text-[#1e3668] uppercase truncate">${item.nome} - ${item.modelo}</p>
                        <p class="text-[8px] text-slate-400 font-bold uppercase">${item.data}</p>
                    </div>
                    <div class="flex gap-2 ml-4">
                        <button onclick="navigator.clipboard.writeText('${item.url}'); alert('Copiado!');" class="p-2 bg-white border rounded-xl"><i data-lucide="copy" class="w-4 h-4"></i></button>
                        <button onclick="window.open('${item.url}', '_blank')" class="p-2 bg-white border rounded-xl"><i data-lucide="external-link" class="w-4 h-4"></i></button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function limparHistorico() {
            if (confirm('Limpar histórico?')) { localStorage.removeItem('historico_propostas'); listarHistorico(); }
        }
    </script>
</body>

</html>